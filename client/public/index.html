<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CR Deck Predictor</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <main>
    <section class="hero container">
      <h1 class="title compact">CR Deck Predictor</h1>
      <p class="subtitle compact">Search and add cards to your deck</p>
      <div class="search-bar center">
        <div class="input-group">
          <input id="cardSearch" type="text" placeholder="Search cards..." />
          <button id="addBtn" type="button">Add</button>
        </div>
      </div>
    </section>

    <section id="decks" class="container">
      <div class="grid deck-grid">
        <article class="card" data-empty="true"><div class="thumb"><div class="placeholder"></div></div><div class="meta"><div class="name"><span class="slot-name">Card 1</span></div><div class="row"><span class="tag">Type</span></div></div></article>
        <article class="card" data-empty="true"><div class="thumb"><div class="placeholder"></div></div><div class="meta"><div class="name"><span class="slot-name">Card 2</span></div><div class="row"><span class="tag">Type</span></div></div></article>
        <article class="card" data-empty="true"><div class="thumb"><div class="placeholder"></div></div><div class="meta"><div class="name"><span class="slot-name">Card 3</span></div><div class="row"><span class="tag">Type</span></div></div></article>
        <article class="card" data-empty="true"><div class="thumb"><div class="placeholder"></div></div><div class="meta"><div class="name"><span class="slot-name">Card 4</span></div><div class="row"><span class="tag">Type</span></div></div></article>
        <article class="card" data-empty="true"><div class="thumb"><div class="placeholder"></div></div><div class="meta"><div class="name"><span class="slot-name">Card 5</span></div><div class="row"><span class="tag">Type</span></div></div></article>
        <article class="card" data-empty="true"><div class="thumb"><div class="placeholder"></div></div><div class="meta"><div class="name"><span class="slot-name">Card 6</span></div><div class="row"><span class="tag">Type</span></div></div></article>
        <article class="card" data-empty="true"><div class="thumb"><div class="placeholder"></div></div><div class="meta"><div class="name"><span class="slot-name">Card 7</span></div><div class="row"><span class="tag">Type</span></div></div></article>
        <article class="card" data-empty="true"><div class="thumb"><div class="placeholder"></div></div><div class="meta"><div class="name"><span class="slot-name">Card 8</span></div><div class="row"><span class="tag">Type</span></div></div></article>
      </div>
    </section>

    <section class="suggestions-section container">
      <h2 class="suggestions-title">Predicted Cards</h2>
      <div class="grid suggestions-grid">
        <article class="suggestion-card" data-slot="1">
          <div class="thumb"><div class="placeholder"></div></div>
          <div class="meta">
            <div class="name"><span class="suggestion-name">-</span></div>
            <div class="row"><span class="frequency">0%</span></div>
          </div>
        </article>
        <article class="suggestion-card" data-slot="2">
          <div class="thumb"><div class="placeholder"></div></div>
          <div class="meta">
            <div class="name"><span class="suggestion-name">-</span></div>
            <div class="row"><span class="frequency">0%</span></div>
          </div>
        </article>
        <article class="suggestion-card" data-slot="3">
          <div class="thumb"><div class="placeholder"></div></div>
          <div class="meta">
            <div class="name"><span class="suggestion-name">-</span></div>
            <div class="row"><span class="frequency">0%</span></div>
          </div>
        </article>
        <article class="suggestion-card" data-slot="4">
          <div class="thumb"><div class="placeholder"></div></div>
          <div class="meta">
            <div class="name"><span class="suggestion-name">-</span></div>
            <div class="row"><span class="frequency">0%</span></div>
          </div>
        </article>
        <article class="suggestion-card" data-slot="5">
          <div class="thumb"><div class="placeholder"></div></div>
          <div class="meta">
            <div class="name"><span class="suggestion-name">-</span></div>
            <div class="row"><span class="frequency">0%</span></div>
          </div>
        </article>
      </div>
    </section>
  </main>

  <footer id="about" class="container">
    Built with plain <strong>HTML</strong> + <strong>CSS</strong> + a tiny bit of <strong>JS</strong> for the Add button.
  </footer>
  <script>
  const input = document.getElementById('cardSearch');
  const addBtn = document.getElementById('addBtn');
  const slots = Array.from(document.querySelectorAll('.card'));

  // Load card data (expects cards.json in same folder as index.html)
  let ALL_CARDS = [];
  fetch('cards.json')
    .then(r => r.json())
    .then(data => { ALL_CARDS = data; })
    .catch(err => console.error('Failed to load cards.json', err));

  // Helpers
  const norm = s => s.trim().toLowerCase();

  function getCardByQuery(q) {
    if (!q) return null;
    const query = norm(q);

    // 1) exact name match
    let card = ALL_CARDS.find(c => norm(c.name) === query);
    if (card) return card;

    // 2) startsWith match
    card = ALL_CARDS.find(c => norm(c.name).startsWith(query));
    if (card) return card;

    // 3) includes match
    return ALL_CARDS.find(c => norm(c.name).includes(query)) || null;
  }

  function slotHasName(slot, name) {
    return norm(slot.querySelector('.slot-name').textContent) === norm(name);
  }

  function deckAlreadyHas(name) {
    return slots.some(s => slotHasName(s, name) && s.dataset.empty === 'false');
  }

  function setSlot(slot, card) {
    // Image src: prefer evolution art if present, else normal medium
    const imgSrc = card.iconUrls?.evolutionMedium || card.iconUrls?.medium || '';
    const thumb = slot.querySelector('.thumb');
    thumb.innerHTML = imgSrc
      ? `<img src="${imgSrc}" alt="${card.name}" loading="lazy">`
      : `<div class="placeholder"></div>`;

    slot.querySelector('.slot-name').textContent = card.name;
    slot.querySelector('.tag').textContent = `${card.rarity ?? 'Card'} â€¢ ${card.elixirCost ?? '?'}âš¡`;
    slot.dataset.empty = 'false';
    slot.classList.add('filled');
  }

  function addToNextSlot() {
    const query = input.value.trim();
    if (!query) {
      wiggle(addBtn);
      return;
    }

    const card = getCardByQuery(query);
    if (!card) {
      wiggle(input);
      return;
    }

    if (deckAlreadyHas(card.name)) {
      // optional: alert / wiggle to indicate duplicate
      wiggle(addBtn);
      return;
    }

    const target = slots.find(s => s.dataset.empty === 'true');
    if (!target) {
      wiggle(addBtn);
      return; // deck full
    }

    setSlot(target, card);
    input.value = '';
    
    // Fetch predictions after adding a card
    fetchPredictions();
  }

  function wiggle(el) {
    el.classList.add('shake');
    setTimeout(() => el.classList.remove('shake'), 350);
  }

  // Fetch card predictions from backend
  async function fetchPredictions() {
    const selectedCards = slots
      .filter(s => s.dataset.empty === 'false')
      .map(s => s.querySelector('.slot-name').textContent);
    
    console.log('ðŸŽ¯ Fetching predictions for:', selectedCards);
    
    // Clear suggestions if deck is empty or full
    if (selectedCards.length === 0 || selectedCards.length === 8) {
      console.log('âš ï¸ Clearing suggestions (empty or full deck)');
      clearSuggestions();
      return;
    }

    try {
      console.log('ðŸ“¡ Calling API...');
      const response = await fetch('http://localhost:5000/api/predict/cards', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cards: selectedCards })
      });

      const data = await response.json();
      console.log('âœ… API Response:', data);
      
      if (data.suggestedCards && data.suggestedCards.length > 0) {
        console.log('ðŸ“‹ Displaying', data.suggestedCards.length, 'suggestions');
        displaySuggestions(data.suggestedCards);
      } else {
        console.log('âš ï¸ No suggestions returned');
        clearSuggestions();
      }
    } catch (error) {
      console.error('âŒ Failed to fetch predictions:', error);
      clearSuggestions();
    }
  }

  // Display predicted cards in suggestion boxes
  function displaySuggestions(suggestions) {
    const suggestionSlots = document.querySelectorAll('.suggestion-card');
    
    suggestions.forEach((suggestion, index) => {
      if (index < suggestionSlots.length) {
        const slot = suggestionSlots[index];
        // API returns { card: "Name", frequency: 40 } not { name: "Name" }
        const cardName = suggestion.card || suggestion.name;
        const card = ALL_CARDS.find(c => norm(c.name) === norm(cardName));
        
        if (card) {
          const imgSrc = card.iconUrls?.evolutionMedium || card.iconUrls?.medium || '';
          const thumb = slot.querySelector('.thumb');
          thumb.innerHTML = imgSrc
            ? `<img src="${imgSrc}" alt="${card.name}" loading="lazy">`
            : `<div class="placeholder"></div>`;
          
          slot.querySelector('.suggestion-name').textContent = card.name;
          slot.querySelector('.frequency').textContent = `${suggestion.frequency}%`;
          slot.dataset.cardName = card.name;
        }
      }
    });

    // Clear remaining slots if fewer than 5 suggestions
    for (let i = suggestions.length; i < 5; i++) {
      clearSuggestionSlot(suggestionSlots[i]);
    }
  }

  // Clear all suggestion boxes
  function clearSuggestions() {
    const suggestionSlots = document.querySelectorAll('.suggestion-card');
    suggestionSlots.forEach(slot => clearSuggestionSlot(slot));
  }

  // Clear a single suggestion slot
  function clearSuggestionSlot(slot) {
    slot.querySelector('.thumb').innerHTML = '<div class="placeholder"></div>';
    slot.querySelector('.suggestion-name').textContent = '-';
    slot.querySelector('.frequency').textContent = '0%';
    slot.dataset.cardName = '';
  }

  // Events: click Add or press Enter
  addBtn.addEventListener('click', addToNextSlot);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') addToNextSlot();
  });

  // Optional: click a filled slot to clear it (handy for testing)
  slots.forEach(slot => {
    slot.addEventListener('click', () => {
      if (slot.dataset.empty === 'false') {
        slot.querySelector('.thumb').innerHTML = '<div class="placeholder"></div>';
        slot.querySelector('.slot-name').textContent = 'Empty';
        slot.querySelector('.tag').textContent = 'Type';
        slot.dataset.empty = 'true';
        slot.classList.remove('filled');
        
        // Fetch new predictions after removing a card
        fetchPredictions();
      }
    });
  });

  // Click suggestion cards to add them to the deck
  const suggestionSlots = document.querySelectorAll('.suggestion-card');
  suggestionSlots.forEach(suggestionSlot => {
    suggestionSlot.addEventListener('click', () => {
      const cardName = suggestionSlot.dataset.cardName;
      if (!cardName || cardName === '') return;

      const card = ALL_CARDS.find(c => norm(c.name) === norm(cardName));
      if (!card) return;

      if (deckAlreadyHas(card.name)) {
        wiggle(suggestionSlot);
        return;
      }

      const target = slots.find(s => s.dataset.empty === 'true');
      if (!target) {
        wiggle(suggestionSlot);
        return;
      }

      setSlot(target, card);
      fetchPredictions();
    });
  });
</script>
  </body>
</html>